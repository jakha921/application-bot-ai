# docker-compose.yml
# –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Telegram Bot –¥–ª—è –∑–∞—è–≤–ª–µ–Ω–∏–π (Uzbekistan)
# –ó–∞–ø—É—Å–∫: docker-compose up -d

version: '3.8'

services:
  # Flask API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  flask-api:
    build:
      context: ./flask-api
      dockerfile: Dockerfile
    container_name: ariza-flask-api
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - DEBUG=False
      - PYTHONUNBUFFERED=1
    volumes:
      - ./flask-api:/app
      - ./temp_documents:/tmp/documents
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ariza-network

  # n8n Workflow Engine
  n8n:
    image: n8nio/n8n:latest
    container_name: ariza-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=changeme123  # –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û!
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Asia/Tashkent
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-workflows:/home/node/.n8n/workflows
    restart: unless-stopped
    depends_on:
      - flask-api
    networks:
      - ariza-network

  # Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  redis:
    image: redis:7-alpine
    container_name: ariza-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - ariza-network

  # Nginx Reverse Proxy (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
  nginx:
    image: nginx:alpine
    container_name: ariza-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - flask-api
      - n8n
    restart: unless-stopped
    networks:
      - ariza-network

volumes:
  n8n_data:
    driver: local
  redis_data:
    driver: local

networks:
  ariza-network:
    driver: bridge

---

# Dockerfile –¥–ª—è Flask API
# –ü—É—Ç—å: ./flask-api/Dockerfile

FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ requirements
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
COPY . .

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 5000

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
CMD ["python", "flask_api_server.py"]

---

# requirements.txt –¥–ª—è Flask API
# –ü—É—Ç—å: ./flask-api/requirements.txt

flask==3.0.0
flask-cors==4.0.0
python-docx==1.1.0
gunicorn==21.2.0
redis==5.0.1

---

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx
# –ü—É—Ç—å: ./nginx/nginx.conf

events {
    worker_connections 1024;
}

http {
    upstream flask_backend {
        server flask-api:5000;
    }

    upstream n8n_backend {
        server n8n:5678;
    }

    # Flask API
    server {
        listen 80;
        server_name api.yourdomain.com;  # –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –î–û–ú–ï–ù

        location / {
            proxy_pass http://flask_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            proxy_read_timeout 300;
            proxy_connect_timeout 300;
        }
    }

    # n8n Web Interface
    server {
        listen 80;
        server_name n8n.yourdomain.com;  # –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –î–û–ú–ï–ù

        location / {
            proxy_pass http://n8n_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support –¥–ª—è n8n
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}

---

# .env —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
# –ü—É—Ç—å: ./.env
# –í–ê–ñ–ù–û: –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ .gitignore!

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_here

# OpenAI
OPENAI_API_KEY=sk-proj-your_key_here

# Anthropic Claude
ANTHROPIC_API_KEY=sk-ant-api03-your_key_here

# n8n Admin
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your_secure_password_here

# Flask
FLASK_SECRET_KEY=your_flask_secret_key_here
FLASK_DEBUG=False

---

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
# –ü—É—Ç—å: ./start.sh
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: chmod +x start.sh && ./start.sh

#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ Telegram Ariza Bot System..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∫–ª—é—á–∞–º–∏."
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p flask-api
mkdir -p nginx/ssl
mkdir -p nginx/logs
mkdir -p n8n-workflows
mkdir -p temp_documents

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker: https://docs.docker.com/get-docker/"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "‚ùå Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose: https://docs.docker.com/compose/install/"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
docker-compose build

echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose ps

echo ""
echo "üéâ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
echo ""
echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "   - Flask API:  http://localhost:5000"
echo "   - n8n:        http://localhost:5678 (admin / changeme123)"
echo "   - Redis:      localhost:6379"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5678"
echo "   2. –í–æ–π–¥–∏—Ç–µ (admin / changeme123)"
echo "   3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ workflow"
echo "   4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ credentials"
echo "   5. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow"
echo ""
echo "üìä –õ–æ–≥–∏:"
echo "   docker-compose logs -f flask-api"
echo "   docker-compose logs -f n8n"
echo ""
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞:"
echo "   docker-compose down"

---

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
# –ü—É—Ç—å: ./health_check.sh

#!/bin/bash

echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã..."
echo ""

# Flask API
echo "1Ô∏è‚É£ Flask API:"
if curl -s http://localhost:5000/health > /dev/null; then
    echo "   ‚úÖ Flask API —Ä–∞–±–æ—Ç–∞–µ—Ç"
    curl -s http://localhost:5000/health | jq
else
    echo "   ‚ùå Flask API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

echo ""

# n8n
echo "2Ô∏è‚É£ n8n:"
if curl -s http://localhost:5678 > /dev/null; then
    echo "   ‚úÖ n8n —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå n8n –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

echo ""

# Redis
echo "3Ô∏è‚É£ Redis:"
if docker exec ariza-redis redis-cli ping > /dev/null 2>&1; then
    echo "   ‚úÖ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå Redis –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

echo ""

# Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "4Ô∏è‚É£ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker-compose ps

echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

---

# .gitignore
# –ü—É—Ç—å: ./.gitignore

# Environment variables
.env
.env.local
.env.*.local

# Docker volumes
docker-compose.override.yml

# Logs
*.log
nginx/logs/*.log

# Temporary files
temp_documents/
*.tmp
*.swp

# Python
__pycache__/
*.py[cod]
*$py.class
venv/
.venv/

# n8n
n8n_data/

# IDE
.vscode/
.idea/
*.sublime-*

# OS
.DS_Store
Thumbs.db
